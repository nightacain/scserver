<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Checkers - –ò–≥—Ä–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen p-4">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="flex justify-between items-center mb-4">
            <div class="text-lg font-bold" id="player-info">
                –ò–≥—Ä–æ–∫: <span id="username"></span>
            </div>
            <button onclick="authService.logout()" 
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                –í—ã–π—Ç–∏
            </button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="flex gap-4">
            <!-- –ò–≥—Ä–æ–≤–∞—è –¥–æ—Å–∫–∞ -->
            <div class="bg-white p-4 rounded-lg shadow-md flex-1">
                <div id="game-status" class="text-center mb-4 text-lg font-bold">
                    –ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –∏–≥—Ä—É" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
                </div>
                
                <div id="board" class="grid grid-cols-8 gap-1 w-96 mx-auto">
                    <!-- –ö–ª–µ—Ç–∫–∏ –¥–æ—Å–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="bg-white p-4 rounded-lg shadow-md w-64">
                <h2 class="text-xl font-bold mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                
                <div class="space-y-4">
                    <button id="find-game-btn" onclick="startSearch()"
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        –ù–∞–π—Ç–∏ –∏–≥—Ä—É
                    </button>
                    
                    <button id="surrender-btn" onclick="surrender()" disabled
                        class="w-full bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                        –°–¥–∞—Ç—å—Å—è
                    </button>
                </div>

                <div id="game-info" class="mt-4">
                    <div id="current-turn" class="text-center font-bold"></div>
                    <div id="your-color" class="text-center mt-2"></div>
                </div>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="message" class="fixed bottom-4 right-4 p-4 rounded shadow-lg hidden"></div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/game-socket.js"></script>
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (!authService.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        const user = authService.getUser();
        document.getElementById('username').textContent = user.username;

        let selectedCell = null;
        let isMyTurn = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏
        function initializeBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const cell = document.createElement('div');
                    cell.className = `w-12 h-12 ${(i + j) % 2 === 0 ? 'bg-gray-200' : 'bg-gray-600'}`;
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.onclick = () => handleCellClick(cell);
                    board.appendChild(cell);
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å–∫–∏
        function updateBoard(boardState) {
            const cells = document.getElementById('board').children;
            
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const cell = cells[i * 8 + j];
                    const piece = boardState[i][j];
                    
                    // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    cell.innerHTML = '';
                    
                    if (piece) {
                        const pieceDiv = document.createElement('div');
                        pieceDiv.className = `w-10 h-10 rounded-full m-1 ${
                            piece.color === 'white' ? 'bg-white' : 'bg-black'
                        } border-2 border-gray-400`;
                        
                        if (piece.isKing) {
                            pieceDiv.innerHTML = 'üëë';
                            pieceDiv.className += ' flex items-center justify-center text-yellow-500';
                        }
                        
                        cell.appendChild(pieceDiv);
                    }
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–ª–µ—Ç–∫–µ
        function handleCellClick(cell) {
            if (!isMyTurn) return;
            
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (selectedCell) {
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥
                gameSocket.makeMove(
                    { row: parseInt(selectedCell.dataset.row), col: parseInt(selectedCell.dataset.col) },
                    { row, col }
                );
                
                selectedCell.classList.remove('ring-2', 'ring-blue-500');
                selectedCell = null;
            } else {
                // –í—ã–±–∏—Ä–∞–µ–º —à–∞—à–∫—É
                const piece = gameSocket.color === 'white' ? 'bg-white' : 'bg-black';
                if (cell.firstChild && cell.firstChild.classList.contains(piece)) {
                    selectedCell = cell;
                    cell.classList.add('ring-2', 'ring-blue-500');
                }
            }
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `fixed bottom-4 right-4 p-4 rounded shadow-lg ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            } text-white`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }

        // –ü–æ–∏—Å–∫ –∏–≥—Ä—ã
        function startSearch() {
            document.getElementById('find-game-btn').disabled = true;
            document.getElementById('game-status').textContent = '–ü–æ–∏—Å–∫ –∏–≥—Ä—ã...';
            gameSocket.findGame();
        }

        // –°–¥–∞—Ç—å—Å—è
        function surrender() {
            gameSocket.surrender();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO
        try {
            gameSocket.connect();
            
            gameSocket.setCallbacks({
                onGameFound: (gameData) => {
                    document.getElementById('game-status').textContent = '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!';
                    document.getElementById('your-color').textContent = `–í–∞—à —Ü–≤–µ—Ç: ${
                        gameData.yourColor === 'white' ? '–±–µ–ª—ã–π' : '—á–µ—Ä–Ω—ã–π'
                    }`;
                    document.getElementById('surrender-btn').disabled = false;
                    updateBoard(gameData.board);
                },
                
                onGameState: (gameState) => {
                    updateBoard(gameState.board);
                    isMyTurn = gameState.currentTurn === user.id;
                    document.getElementById('current-turn').textContent = 
                        isMyTurn ? '–í–∞—à —Ö–æ–¥' : '–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
                },
                
                onGameEnded: (data) => {
                    const isWinner = data.winner === user.id;
                    document.getElementById('game-status').textContent = 
                        isWinner ? '–í—ã –ø–æ–±–µ–¥–∏–ª–∏!' : '–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!';
                    document.getElementById('surrender-btn').disabled = true;
                    document.getElementById('find-game-btn').disabled = false;
                    showMessage(
                        isWinner ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!' : '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞',
                        isWinner ? 'info' : 'error'
                    );
                },
                
                onError: (error) => {
                    showMessage(error, 'error');
                },
                
                onWaiting: () => {
                    document.getElementById('game-status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...';
                }
            });
        } catch (error) {
            showMessage(error.message, 'error');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initializeBoard();
    </script>
</body>
</html> 